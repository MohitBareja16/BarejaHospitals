{% extends "base.html" %} {% block content %}
<div class="container">
  <h2 class="mb-4">My Health Dashboard</h2>

  <div class="row">
    <div class="col-md-6">
      <div class="card shadow mb-4">
        <div class="card-header bg-info text-white">Find a Doctor</div>
        <div class="card-body">
      <p>Select a department to view specialists:</p>

      <div class="mb-3">
        <div class="input-group">
          <input type="text" id="doctorSearch" class="form-control" placeholder="Search for department or doctor...">
          <button class="btn btn-outline-secondary" type="button"><i class="bi bi-search"></i></button>
        </div>
      </div>

      <div class="list-group" id="deptList">
        {% for dept in departments %}
          <a href="/department/{{ dept.id }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center search-item">
            <span>
              <strong>{{ dept.name }}</strong>
              <small class="text-muted d-block">{{ dept.description|default('No description available', true)|truncate(50) }}</small>
            </span>
            <span class="badge bg-primary rounded-pill">View</span>
          </a>
        {% endfor %}
      </div>

      <script>
        (function(){
        var input = document.getElementById('doctorSearch');
        if (!input) return;
        input.addEventListener('keyup', function() {
          var filter = this.value.toLowerCase();
          var items = document.querySelectorAll('.search-item');
          items.forEach(function(item) {
            var text = item.textContent.toLowerCase();
            if (text.indexOf(filter) !== -1) {
              item.style.display = '';
            } else {
              item.style.display = 'none';
            }
          });
        });
        })();
      </script>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow">
        <div class="card-header bg-secondary text-white">My Appointments</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Doctor</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for appt in appointments %}
                <tr>
                  <td>
                    {{ appt.date_scheduled }}<br />
                    <small class="text-muted">{{ appt.time_scheduled }}</small>
                  </td>
                  <td>
                    {{ appt.doctor.full_name }}<br />
                    <small class="text-muted"
                      >{{ appt.doctor.department.name }}</small
                    >
                  </td>
                  <td>
                    {% if appt.status == 'Completed' %}
                    <span class="badge bg-success">Visited</span>
                    {% elif appt.status == 'Cancelled' %}
                    <span class="badge bg-danger">Cancelled</span>
                    {% else %}
                    <span class="badge bg-warning text-dark">Upcoming</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if appt.status == 'Completed' and appt.treatment %}
                    <button
                      class="btn btn-sm btn-outline-primary"
                      data-bs-toggle="modal"
                      data-bs-target="#viewPrescription{{ appt.id }}"
                    >
                      View Rx
                    </button>

                    <div
                      class="modal fade"
                      id="viewPrescription{{ appt.id }}"
                      tabindex="-1"
                    >
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header bg-light">
                            <h5 class="modal-title">Medical Record</h5>
                            <button
                              type="button"
                              class="btn-close"
                              data-bs-dismiss="modal"
                            ></button>
                          </div>
                          <div class="modal-body">
                            <h6>Diagnosis</h6>
                            <p class="p-2 bg-light border rounded">
                              {{ appt.treatment.diagnosis }}
                            </p>
                            <hr />
                            <h6>Prescription</h6>
                            <p class="p-2 bg-light border rounded">
                              {{ appt.treatment.prescription }}
                            </p>
                            <small class="text-muted"
                              >Date: {{
                              appt.treatment.date_created.strftime('%Y-%m-%d')
                              }}</small
                            >
                          </div>
                        </div>
                      </div>
                    </div>

                    {% elif appt.status == 'Scheduled' %}
                    <a href="/reschedule/{{ appt.id }}" class="btn btn-sm btn-outline-warning text-dark me-2">
                      Reschedule
                    </a>

                    <a
                      href="/cancel_appointment/{{ appt.id }}"
                      class="btn btn-sm btn-outline-danger"
                      onclick="return confirm('Are you sure you want to cancel?');"
                    >
                      Cancel
                    </a>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
